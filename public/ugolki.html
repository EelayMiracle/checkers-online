<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–£–≥–æ–ª–∫–∏ Multiplayer</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/png" href="icon.png">
<style>
  /* –¢–æ–ª—å–∫–æ –¥–≤–µ —Å—Ç—Ä–æ—á–∫–∏ –Ω—É–∂–Ω—ã –∏–º–µ–Ω–Ω–æ –¥–ª—è –£–≥–æ–ª–∫–æ–≤ */
  .cell.target-white { box-shadow: inset 0 0 0 3.5px rgba(255,255,255,0.75); }
  .cell.target-black { box-shadow: inset 0 0 0 3.5px rgba(0,0,0,0.65); }
  .piece.jumping { box-shadow: 0 0 20px 6px rgba(0,255,100,0.9) !important; }
</style>
</head>
<body>

<nav class="game-switch">
  <button class="game-switch__btn" id="goToCheckers">–®–∞—à–∫–∏</button>
  <span class="game-switch__label">–£–≥–æ–ª–∫–∏</span>
</nav>

<div class="controls">
  <button class="bubbly-button" id="createRoom">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
  <button class="bubbly-button" id="rematch" disabled>–†–µ–º–∞—Ç—á</button>
  <button class="bubbly-button" id="invite" disabled>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>

  <div class="volume-control-inline">
    <span style="font-size:20px">üîä</span>
    <input type="range" id="volumeSlider" min="0" max="100" value="50">
    <span id="volumeValue">50%</span>
  </div>

  <div id="toast" class="toast">—Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞</div>
</div>

<div id="winnerBanner" class="winner-banner" style="display:none;"></div>

<!-- –¢–û–ß–ù–û –¢–ê–ö–ê–Ø –ñ–ï –®–ê–ü–ö–ê –ö–ê–ö –í –®–ê–®–ö–ê–• ‚Äî –ù–ò–ö–ê–ö–ò–• turn-panel –∏ –ø—Ä–æ—á–µ–π –µ—Ä—É–Ω–¥—ã -->
<div class="topbar" id="topbar" style="display:none;">
  <div class="player-card left" id="p1Card"></div>

  <div id="turnDisplay">
    <span class="turn-label">–•–æ–¥:</span>
    <span id="turnColorBox"></span>
  </div>

  <div class="player-card right" id="p2Card"></div>
</div>

<div id="board"></div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ‚Äî 100% –∫–∞–∫ –≤ —à–∞—à–∫–∞—Ö -->
<div class="modal-backdrop" id="profileModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
    <h2 id="profileTitle">–ò–º—è –∏–≥—Ä–æ–∫–∞ –∏ –∞–≤–∞—Ç–∞—Ä</h2>
    <div class="row">
      <label for="profileName">–ò–º—è:</label>
      <input id="profileName" placeholder="–í–∞—à –Ω–∏–∫" maxlength="15" />
    </div>
    <div class="row" style="align-items:flex-start;">
      <div>
        <div style="font-weight:800; margin-bottom:6px;">–ê–≤–∞—Ç–∞—Ä:</div>
        <div class="avatar-grid" id="avatarGrid"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="bubbly-button" id="profileOk">–û–ö</button>
    </div>
  </div>
</div>

<script>
// ======================== –£–ì–û–õ–ö–ò ‚Äî –í–°–Å –û–°–¢–ê–õ–¨–ù–û–ï 100% –ò–ó –®–ê–®–ï–ö ========================
let roomId=null, playerColor=null, selectedPiece=null;
let seat=null;
let roomState=null;
let legalMoves=[];
const boardEl=document.getElementById('board');
const CLIENT_ID_KEY='ugolki_client_id_v2';
function getOrCreateClientId(){
  let v=sessionStorage.getItem(CLIENT_ID_KEY);
  if(v) return v;
  v = crypto?.randomUUID?.() || Date.now()+"_"+Math.random().toString(36).slice(2);
  sessionStorage.setItem(CLIENT_ID_KEY,v);
  return v;
}
const clientId=getOrCreateClientId();

const PROFILE_NAME_KEY=s=>`ugolki_profile_name_v2_seat_${s}`;
const PROFILE_AVATAR_KEY=s=>`ugolki_profile_avatar_v2_seat_${s}`;
const AVATARS=["üòÉ","üòä","üòà","üëΩ","ü§ñ","üëª","üòº","ü¶ä","üêØ","ü¶Å","üêâ","üê•","ü¶ã"];
let chosenAvatar=null;
let profileConfirmed=false;
let lastGameId=null;
let lastPlayedMoveId=0;

const toastEl=document.getElementById('toast');
const winnerBannerEl=document.getElementById('winnerBanner');
const topbarEl=document.getElementById('topbar');
const p1Card=document.getElementById('p1Card');
const p2Card=document.getElementById('p2Card');

function showToast(t){toastEl.textContent=t;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),2000);}
function escapeHtml(s){return(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

function makeMiniLoader(){
  return `<span class="mini-loader"><span class="bar1"></span><span class="bar2"></span><span class="bar3"></span><span class="bar4"></span><span class="bar5"></span><span class="bar6"></span></span><span class="waiting-text">–æ–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞</span>`;
}

function renderPlayerCards(state){
  if(!state||!roomId){topbarEl.style.display='none';return;}
  topbarEl.style.display='flex';
  const p1=state.profiles?.p1||{avatar:'üôÇ',name:''};
  const p2=state.profiles?.p2||{avatar:'üôÇ',name:''};
  const p1Color=state.colors?.p1||'white';
  const p2Color=state.colors?.p2||'black';
  const p1Class=p1Color==='black'?'black':'white';
  const p2Class=p2Color==='black'?'black':'white';

  p1Card.innerHTML=`
    <span class="avatar">${p1.avatar||'üôÇ'}</span>
    <span class="player-lines">
      <span class="title">–ò–≥—Ä–æ–∫ 1</span>
      ${p1.name?`<span class="name">${escapeHtml(p1.name)}</span>`:''}
    </span>
    <span class="color-box ${p1Class}" title="–∫–æ–º–∞–Ω–¥–∞"></span>
  `;

  p2Card.innerHTML=state.connected?.p2?`
    <span class="color-box ${p2Class}" title="–∫–æ–º–∞–Ω–¥–∞"></span>
    <span class="player-lines" style="text-align:right;">
      <span class="title">–ò–≥—Ä–æ–∫ 2</span>
      ${p2.name?`<span class="name">${escapeHtml(p2.name)}</span>`:''}
    </span>
    <span class="avatar">${p2.avatar||'üôÇ'}</span>
  `:makeMiniLoader();
}

function setWinnerBanner(text){
  winnerBannerEl.style.display=text?'block':'none';
  winnerBannerEl.textContent=text||'';
}

function clearMoveDots(){document.querySelectorAll('.move-dot').forEach(d=>d.remove());}
function renderMoveDots(moves){
  clearMoveDots();
  moves.forEach(m=>{ 
    const cell=boardEl.querySelector(`.cell[data-x="${m.x}"][data-y="${m.y}"]`);
    if(cell){ const dot=document.createElement('div'); dot.className='move-dot'; cell.appendChild(dot); }
  });
}

// === –õ–û–ì–ò–ö–ê –£–ì–û–õ–ö–û–í ===
function getTargetCells(color){
  const cells=[];
  if(color==='white') for(let y=0;y<3;y++)for(let x=0;x<3;x++) cells.push({x,y});
  else for(let y=5;y<8;y++)for(let x=5;x<8;x++) cells.push({x,y});
  return cells;
}

function checkWin(board){
  const whiteTarget=getTargetCells('white');
  const blackTarget=getTargetCells('black');
  const whiteOk=whiteTarget.every(c=>board[c.y][c.x]?.color==='white');
  const blackOk=blackTarget.every(c=>board[c.y][c.x]?.color==='black');
  if(whiteOk) return 'white';
  if(blackOk) return 'black';
  return null;
}

function getMoves(board, pos){
  const piece=board[pos.y][pos.x];
  if(!piece) return [];
  const dirs=[[0,1],[0,-1],[1,0],[-1,0]];
  const moves=[];
  for(const [dx,dy] of dirs){
    const sx=pos.x+dx, sy=pos.y+dy;
    if(sx>=0&&sx<8&&sy>=0&&sy<8 && !board[sy][sx]) moves.push({x:sx,y:sy}); // —à–∞–≥
    const jx=pos.x+2*dx, jy=pos.y+2*dy;
    if(jx>=0&&jx<8&&jy>=0&&jy<8 && board[sy][sx] && !board[jy][jx]) moves.push({x:jx,y:jy}); // –ø—Ä—ã–∂–æ–∫
  }
  return moves;
}

function computeLegalDestinations(board, color, selected, state){
  if(state.turn!==color || state.winner) return [];
  const piece=board[selected.y][selected.x];
  if(!piece || piece.color!==color) return [];
  if(state.jumpingFrom && (selected.x!==state.jumpingFrom.x || selected.y!==state.jumpingFrom.y)) return [];
  return getMoves(board, selected);
}

function createBoardUI(){
  boardEl.innerHTML='';
  const whiteT=getTargetCells('white');
  const blackT=getTargetCells('black');
  for(let y=0;y<8;y++)for(let x=0;x<8;x++){
    const cell=document.createElement('div');
    cell.className='cell '+((x+y)%2===0?'white':'black');
    cell.dataset.x=x; cell.dataset.y=y;
    if(whiteT.some(p=>p.x===x&&p.y===y)) cell.classList.add('target-white');
    if(blackT.some(p=>p.x===x&&p.y===y)) cell.classList.add('target-black');
    boardEl.appendChild(cell);
  }
}

function renderBoard(board){
  createBoardUI();
  for(let y=0;y<8;y++)for(let x=0;x<8;x++){
    if(board[y][x]){
      const cell=boardEl.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
      const p=document.createElement('div');
      p.className='piece '+board[y][x].color;
      if(selectedPiece?.x===x && selectedPiece?.y===y) p.classList.add('selected');
      if(roomState?.jumpingFrom?.x===x && roomState?.jumpingFrom?.y===y) p.classList.add('jumping');
      cell.appendChild(p);
    }
  }
  renderMoveDots(legalMoves);
}

function startPolling(){
  setInterval(async()=>{
    if(!roomId) return;
    const r=await fetch(`/ugolki/room/${roomId}/state`);
    const d=await r.json();

    if(d.gameId!==undefined && lastGameId!==null && d.gameId!==lastGameId){
      await joinRoomById(roomId,{showModal:false,keepProfileConfirmed:true});
      selectedPiece=null; legalMoves=[]; clearMoveDots(); setWinnerBanner(); lastPlayedMoveId=0;
    }
    lastGameId=d.gameId;

    if(d.lastMoveId > lastPlayedMoveId && d.lastMoveBy!==playerColor && d.lastMoveSound) playSound(d.lastMoveSound);
    lastPlayedMoveId=d.lastMoveId;

    roomState=d;

    document.getElementById('turnColorBox').style.cssText = d.turn==='white' 
      ? 'background:#fff;border:1px solid #000' 
      : 'background:#000;border:1px solid #fff';

    if(!playerColor || d.turn!==playerColor){ selectedPiece=null; legalMoves=[]; }

    if(d.jumpingFrom && d.turn===playerColor){
      selectedPiece={x:d.jumpingFrom.x,y:d.jumpingFrom.y};
    }

    legalMoves = selectedPiece ? computeLegalDestinations(d.board,playerColor,selectedPiece,d) : [];

    const winner=checkWin(d.board);
    if(winner){
      const name=(d.profiles?.[winner==='white'?'p1':'p2']?.name||'').trim()||`–ò–≥—Ä–æ–∫ ${winner==='white'?1:2}`;
      setWinnerBanner(`–ü–æ–±–µ–¥–∏–ª ${name}!`);
    }else setWinnerBanner();

    renderPlayerCards(d);
    document.getElementById('invite').disabled=!roomId;
    document.getElementById('rematch').disabled=!roomId;
    renderBoard(d.board);
  },700);
}

async function joinRoomById(id,{showModal=true,keepProfileConfirmed=false}={}){
  const r=await fetch(`/ugolki/room/${id}/join?clientId=${clientId}`);
  const d=await r.json();
  if(d.error){alert(d.error);return;}
  roomId=id; playerColor=d.color; seat=d.seat; profileConfirmed=keepProfileConfirmed||false;
  boardEl.classList.toggle('flipped',playerColor==='black');
  document.getElementById('invite').disabled=false;
  document.getElementById('rematch').disabled=false;
  if(showModal) showProfileModal(seat===1?'–ò–≥—Ä–æ–∫ 1':'–ò–≥—Ä–æ–∫ 2');
}

function showProfileModal(title){
  document.getElementById('profileTitle').textContent=`–ò–º—è –∏–≥—Ä–æ–∫–∞ –∏ –∞–≤–∞—Ç–∞—Ä (${title})`;
  const name=localStorage.getItem(PROFILE_NAME_KEY(seat))||'';
  document.getElementById('profileName').value=name;
  chosenAvatar=localStorage.getItem(PROFILE_AVATAR_KEY(seat))||AVATARS[Math.floor(Math.random()*AVATARS.length)];
  const grid=document.getElementById('avatarGrid'); grid.innerHTML='';
  AVATARS.forEach(a=>{const el=document.createElement('div');el.className='avatar-choice'+(a===chosenAvatar?' selected':'');el.textContent=a;el.onclick=()=>{chosenAvatar=a;grid.querySelectorAll('.avatar-choice').forEach(x=>x.classList.remove('selected'));el.classList.add('selected');};grid.appendChild(el);});
  document.getElementById('profileModalBackdrop').classList.add('show');
}

document.getElementById('profileOk').onclick=async()=>{
  const name=document.getElementById('profileName').value.trim();
  const avatar=chosenAvatar;
  localStorage.setItem(PROFILE_NAME_KEY(seat),name);
  localStorage.setItem(PROFILE_AVATAR_KEY(seat),avatar);
  await fetch(`/ugolki/room/${roomId}/profile`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clientId,name,avatar})});
  profileConfirmed=true;
  document.getElementById('profileModalBackdrop').classList.remove('show');
};

document.getElementById('createRoom').onclick=async()=>{const r=await fetch('/ugolki/room/create');const d=await r.json();roomId=d.roomId;await joinRoomById(roomId,{showModal:true});};
document.getElementById('goToCheckers').onclick=()=>{location.href='index.html';};
document.getElementById('invite').onclick=()=>{navigator.clipboard?.writeText?.(`${location.origin}${location.pathname}?room=${roomId}`).then(()=>showToast('—Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'))};
document.getElementById('rematch').onclick=async()=>{await fetch(`/ugolki/room/${roomId}/rematch`,{method:'POST'});await joinRoomById(roomId,{showModal:false,keepProfileConfirmed:true});setWinnerBanner();selectedPiece=null;legalMoves=[];};

boardEl.onclick=async e=>{
  const cell=e.target.closest('.cell');
  if(!cell||!playerColor||!profileConfirmed||!roomState||roomState.winner) return;
  const x=+cell.dataset.x, y=+cell.dataset.y;
  const piece=cell.querySelector('.piece');

  if(piece && piece.classList.contains(playerColor)){
    if(roomState.turn!==playerColor) return;
    if(roomState.jumpingFrom && (x!==roomState.jumpingFrom.x || y!==roomState.jumpingFrom.y)) return;
    document.querySelectorAll('.piece.selected').forEach(p=>p.classList.remove('selected'));
    piece.classList.add('selected');
    selectedPiece={x,y};
    legalMoves=computeLegalDestinations(roomState.board,playerColor,selectedPiece,roomState);
    renderMoveDots(legalMoves);
    return;
  }

  if(selectedPiece && legalMoves.some(m=>m.x===x&&m.y===y)){
    const res=await fetch(`/ugolki/room/${roomId}/move`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({from:selectedPiece,to:{x,y},player:playerColor})});
    const d=await res.json();
    if(d.error) return showToast(d.error);
    if(d.lastMoveSound) playSound(d.lastMoveSound);
    if(d.lastMoveId) lastPlayedMoveId=d.lastMoveId;

    if(d.jumpingFrom){
      selectedPiece={x:d.jumpingFrom.x,y:d.jumpingFrom.y};
      legalMoves=computeLegalDestinations(d.board,playerColor,selectedPiece,d);
      renderBoard(d.board);
    }else{
      selectedPiece=null; legalMoves=[]; clearMoveDots();
      renderBoard(d.board);
    }
  }
};

function applyBubblyButtonAnimations(){
  document.querySelectorAll('.bubbly-button').forEach(b=>b.addEventListener('click',e=>{e.preventDefault();b.classList.add('animate');setTimeout(()=>b.classList.remove('animate'),700);}));
}

createBoardUI();
startPolling();
applyBubblyButtonAnimations();

(async()=>{ const room=getRoomIdFromUrl(); if(room) await joinRoomById(room); })();
function getRoomIdFromUrl(){ const p=new URL(location.href).searchParams.get('room'); return p||null; }

const sounds={move:new Audio('sounds/woosh.mp3'),capture:new Audio('sounds/woosh.mp3')};
let volume=0.5;
document.getElementById('volumeSlider').oninput=e=>setVolume(e.target.value/100);
document.addEventListener('click',()=>{sounds.move.play().catch(()=>{});},{once:true});
function setVolume(v){volume=v;Object.values(sounds).forEach(s=>s.volume=v);document.getElementById('volumeValue').textContent=Math.round(v*100)+'%';}
function playSound(t){if(sounds[t]){sounds[t].currentTime=0;sounds[t].play().catch(()=>{});}}
setVolume(0.5);
</script>
</body>
</html>