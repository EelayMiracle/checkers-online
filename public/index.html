<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Checkers Multiplayer</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/png" href="icon.png">
</head>
<body>

<div class="controls">
  <button class="bubbly-button" id="createRoom">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
  <button class="bubbly-button" id="rematch" disabled>–†–µ–º–∞—Ç—á</button>
  <button class="bubbly-button" id="invite" disabled>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>

  <input id="roomIdInput" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
  <button class="bubbly-button" id="joinRoom">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>

  <div id="toast" class="toast">—Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞</div>
</div>

<div id="winnerBanner" class="winner-banner" style="display:none;"></div>

<div class="topbar" id="topbar" style="display:none;">
  <div class="player-card left" id="p1Card"></div>
  <div class="player-card right" id="p2Card"></div>
</div>

<div id="turnDisplay">
  <span class="turn-label">–•–æ–¥:</span>
  <span id="turnColorBox"></span>
</div>
<div class="volume-control">
  <span style="font-size:20px">üîä</span>
  <input type="range" id="volumeSlider" min="0" max="100" value="60">
  <span id="volumeValue">60%</span>
</div>
<div id="board"></div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–º–µ–Ω–∏ –∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
<div class="modal-backdrop" id="profileModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
    <h2 id="profileTitle">–ò–º—è –∏–≥—Ä–æ–∫–∞ –∏ –∞–≤–∞—Ç–∞—Ä</h2>

    <div class="row">
      <label for="profileName">–ò–º—è:</label>
      <input id="profileName" placeholder="–í–∞—à –Ω–∏–∫" />
    </div>

    <div class="row" style="align-items:flex-start;">
      <div>
        <div style="font-weight:800; margin-bottom:6px;">–ê–≤–∞—Ç–∞—Ä:</div>
        <div class="avatar-grid" id="avatarGrid"></div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="bubbly-button" id="profileOk">–û–ö</button>
    </div>
  </div>
</div>

<script>
let roomId=null, playerColor=null, selectedPiece=null;
let seat=null; // 1 –∏–ª–∏ 2
let roomState=null; // –ø–æ–ª–Ω—ã–π state –∫–æ–º–Ω–∞—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ (/state)
let legalMoves=[];  // [{x,y}, ...] –∫–ª–µ—Ç–∫–∏, –∫—É–¥–∞ –º–æ–∂–Ω–æ —Å—Ö–æ–¥–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —à–∞—à–∫–æ–π
const boardEl=document.getElementById('board');

// –£—Å—Ç–æ–π—á–∏–≤—ã–π id –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ä–∞–º–∫–∞—Ö –≤–∫–ª–∞–¥–∫–∏ (sessionStorage),
// —á—Ç–æ–±—ã –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –ø–æ —Å—Å—ã–ª–∫–µ –¥—Ä—É–≥ –Ω–µ —Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è —Ç–µ–º –∂–µ –∏–≥—Ä–æ–∫–æ–º.
const CLIENT_ID_KEY='checkers_client_id_v1';
function getOrCreateClientId(){
  let v=sessionStorage.getItem(CLIENT_ID_KEY);
  if(v) return v;
  v = (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)));
  sessionStorage.setItem(CLIENT_ID_KEY,v);
  return v;
}
const clientId=getOrCreateClientId();
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—Ç–∏–º—Å—è –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏ "–¥—É–±–ª–∏–∫–∞—Ç –≤–∫–ª–∞–¥–∫–∏" (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π sessionStorage):
// –µ—Å–ª–∏ –¥–≤–∞ –æ–∫–Ω–∞ —É–≤–∏–¥–µ–ª–∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ clientId, –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö —Å–∞–º —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π.
// –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤ –æ–¥–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –¥—Ä—É–≥–∞ –∏ —Å—Ç–∞—Ç—å –ò–≥—Ä–æ–∫–æ–º 2.
const INSTANCE_ID=(crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)));
try{
  const bc=new BroadcastChannel('checkers_client_presence_v1');
  bc.onmessage=(ev)=>{
    const msg=ev?.data;
    if(!msg || msg.type!=='hello') return;
    if(msg.clientId!==clientId) return;
    if(msg.instanceId===INSTANCE_ID) return;

    // –∫–æ–ª–ª–∏–∑–∏—è clientId: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ—Ç instanceId, –∫–æ—Ç–æ—Ä—ã–π "–º–µ–Ω—å—à–µ", –≤—Ç–æ—Ä–æ–π –≥–µ–Ω–µ—Ä–∏—Ç –Ω–æ–≤—ã–π id.
    // (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
    if(String(INSTANCE_ID) > String(msg.instanceId)){
      const newId=(crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)));
      sessionStorage.setItem(CLIENT_ID_KEY,newId);
      location.reload();
    }
  };
  bc.postMessage({type:'hello',clientId,instanceId:INSTANCE_ID});
}catch{
  // BroadcastChannel –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
}

// –ü—Ä–æ—Ñ–∏–ª—å
// –ü—Ä–æ—Ñ–∏–ª—å —Ö—Ä–∞–Ω–∏–º –†–ê–ó–î–ï–õ–¨–ù–û –ø–æ seat, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–æ—Å—å –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏
const PROFILE_NAME_KEY=(s)=>`checkers_profile_name_v1_seat_${s}`;
const PROFILE_AVATAR_KEY=(s)=>`checkers_profile_avatar_v1_seat_${s}`;
const AVATARS=["üòÉ","üòä","üòà","üëΩ","ü§ñ","üëª","üòº","ü¶ä","üêØ","ü¶Å","üêâ","üê•","ü¶ã"];
let chosenAvatar=null;
let profileConfirmed=false;
let lastGameId=null;

// UI refs
const toastEl=document.getElementById('toast');
const winnerBannerEl=document.getElementById('winnerBanner');
const topbarEl=document.getElementById('topbar');
const p1Card=document.getElementById('p1Card');
const p2Card=document.getElementById('p2Card');

function showToast(text){
  if(!toastEl) return;
  toastEl.textContent=text;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'),2000);
}

function countPieces(board){
  let white=0, black=0;
  for(let y=0;y<8;y++)for(let x=0;x<8;x++){
    const p=board?.[y]?.[x];
    if(!p) continue;
    if(p.color==='white') white++;
    if(p.color==='black') black++;
  }
  return {white,black};
}

function seatKeyFromSeat(seat){
  return seat===1 ? 'p1' : (seat===2 ? 'p2' : null);
}

function seatNumberFromKey(key){
  return key==='p1' ? 1 : (key==='p2' ? 2 : null);
}

function seatKeyForColor(state,color){
  if(!state?.colors) return null;
  if(state.colors.p1===color) return 'p1';
  if(state.colors.p2===color) return 'p2';
  return null;
}

function makeMiniLoader(){
  return `
    <span class="mini-loader" aria-label="loading">
      <span class="bar1"></span><span class="bar2"></span><span class="bar3"></span>
      <span class="bar4"></span><span class="bar5"></span><span class="bar6"></span>
    </span>
    <span class="waiting-text">–æ–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞</span>
  `;
}

function renderPlayerCards(state){
  if(!state || !roomId){
    topbarEl.style.display='none';
    return;
  }
  topbarEl.style.display='flex';

  const p1=state.profiles?.p1 || {avatar:'üôÇ', name:''};
  const p2=state.profiles?.p2 || {avatar:'üôÇ', name:''};
  const p1Color=state.colors?.p1 || 'white';
  const p2Color=state.colors?.p2 || 'black';

  const p1ColorClass = p1Color==='black' ? 'black' : 'white';
  const p2ColorClass = p2Color==='black' ? 'black' : 'white';

  // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:
  // –ê–≤–∞—Ç–∞—Ä  –ò–≥—Ä–æ–∫ 1
  //         –ò–º—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
  p1Card.innerHTML = `
    <span class="avatar">${p1.avatar||'üôÇ'}</span>
    <span class="player-lines">
      <span class="title">–ò–≥—Ä–æ–∫ 1</span>
      ${p1.name ? `<span class="name">${escapeHtml(p1.name)}</span>` : ''}
    </span>
    <span class="color-box ${p1ColorClass}" title="–∫–æ–º–∞–Ω–¥–∞"></span>
  `;

  if(state.connected?.p2){
    p2Card.innerHTML = `
      <span class="color-box ${p2ColorClass}" title="–∫–æ–º–∞–Ω–¥–∞"></span>
      <span class="player-lines" style="text-align:right;">
        <span class="title">–ò–≥—Ä–æ–∫ 2</span>
        ${p2.name ? `<span class="name">${escapeHtml(p2.name)}</span>` : ''}
      </span>
      <span class="avatar">${p2.avatar||'üôÇ'}</span>
    `;
  }else{
    p2Card.innerHTML = makeMiniLoader();
  }
}

function escapeHtml(str){
  return (str||'').replace(/[&<>"']/g,(c)=>({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[c]));
}

function setWinnerBanner(text){
  if(!text){
    winnerBannerEl.style.display='none';
    winnerBannerEl.textContent='';
    return;
  }
  winnerBannerEl.textContent=text;
  winnerBannerEl.style.display='block';
}

function clearMoveDots(){
  document.querySelectorAll('.move-dot').forEach(el=>el.remove());
}

function renderMoveDots(destinations){
  clearMoveDots();
  for(const {x,y} of destinations){
    const cell=boardEl.querySelector(`.cell[data-x='${x}'][data-y='${y}']`);
    if(!cell) continue;
    const dot=document.createElement('div');
    dot.className='move-dot';
    cell.appendChild(dot);
  }
}

// ===== –õ–û–ö–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –•–û–î–û–í (–∫–æ–ø–∏—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–π), –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä =====
function isClearDiagonal(board,from,to){
  const dx=Math.sign(to.x-from.x), dy=Math.sign(to.y-from.y);
  let x=from.x+dx, y=from.y+dy;
  while(x!==to.x){
    if(board[y][x]) return false;
    x+=dx; y+=dy;
  }
  return true;
}

function hasAnyCaptureOnBoard(board,pos,piece){
  const dirs=[[1,1],[1,-1],[-1,1],[-1,-1]];
  const inBounds=(x,y)=>x>=0&&x<8&&y>=0&&y<8;

  if(piece.king){
    for(const [dX,dY] of dirs){
      let x=pos.x+dX, y=pos.y+dY;
      while(inBounds(x,y)){
        const t=board[y][x];
        if(!t){
          x+=dX; y+=dY;
          continue;
        }
        if(t.color===piece.color) break;
        // –Ω–∞—à–ª–∏ –≤—Ä–∞–≥–∞ ‚Äî –Ω—É–∂–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞ –∑–∞ –Ω–∏–º
        x+=dX; y+=dY;
        while(inBounds(x,y)){
          const t2=board[y][x];
          if(!t2) return true;
          break;
        }
        break;
      }
    }
    return false;
  }

  for(const [dX,dY] of dirs){
    const mx=pos.x+dX,my=pos.y+dY;
    const tx=pos.x+2*dX,ty=pos.y+2*dY;
    if(!inBounds(tx,ty)) continue;
    const mid=board?.[my]?.[mx];
    if(mid && mid.color!==piece.color && !board[ty][tx]) return true;
  }
  return false;
}

function getCaptures(board,pos,piece){
  const dirs=[[1,1],[1,-1],[-1,1],[-1,-1]];
  const res=[];
  if(piece.king){
    // –î–∞–º–∫–∞: –ø–æ—Å–ª–µ –≤–∑—è—Ç–∏—è –º–æ–∂–Ω–æ –ø—Ä–∏–∑–µ–º–ª–∏—Ç—å—Å—è –Ω–∞ –ª—é–±—É—é –∫–ª–µ—Ç–∫—É –∑–∞ –±–∏—Ç–æ–π —à–∞—à–∫–æ–π.
    // –ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –µ—Å–ª–∏ —Å—Ä–µ–¥–∏ –∫–ª–µ—Ç–æ–∫ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏—è –µ—Å—Ç—å —Ç–∞–∫–∏–µ, —Å –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–æ–π,
    // —Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –¢–û–õ–¨–ö–û –æ–Ω–∏ (–Ω–µ–ª—å–∑—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –±–ª–∏–∂–Ω–µ–π –∫–ª–µ—Ç–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∞–ª—å—à–µ).

    const inBounds=(x,y)=>x>=0&&x<8&&y>=0&&y<8;
    const cloneBoard=(b)=>b.map(row=>row.map(p=>p?{...p}:null));

    for(const[dX,dY]of dirs){
      let x=pos.x+dX,y=pos.y+dY;
      let enemy=null;
      while(inBounds(x,y)){
        const t=board[y][x];
        if(t){
          if(t.color===piece.color) break;
          enemy={x,y};
          break;
        }
        x+=dX; y+=dY;
      }
      if(!enemy) continue;

      const landings=[];
      x=enemy.x+dX; y=enemy.y+dY;
      while(inBounds(x,y) && !board[y][x]){
        landings.push({x,y});
        x+=dX; y+=dY;
      }
      if(landings.length===0) continue;

      const landingWithContinuation=[];
      for(const landing of landings){
        const sim=cloneBoard(board);
        sim[pos.y][pos.x]=null;
        sim[enemy.y][enemy.x]=null;
        sim[landing.y][landing.x]={...piece};
        if(hasAnyCaptureOnBoard(sim,{x:landing.x,y:landing.y},sim[landing.y][landing.x])) landingWithContinuation.push(landing);
      }

      const allowedLandings = landingWithContinuation.length>0 ? landingWithContinuation : landings;
      for(const landing of allowedLandings){
        res.push({from:pos,over:enemy,to:{x:landing.x,y:landing.y}});
      }
    }
  }else{
    for(const[dX,dY]of dirs){
      const mx=pos.x+dX,my=pos.y+dY;
      const tx=pos.x+2*dX,ty=pos.y+2*dY;
      if(tx<0||tx>7||ty<0||ty>7) continue;
      const mid=board[my][mx];
      if(mid&&mid.color!==piece.color&&!board[ty][tx])
        res.push({from:pos,over:{x:mx,y:my},to:{x:tx,y:ty}});
    }
  }
  return res;
}

function playerMustCapture(board,color){
  for(let y=0;y<8;y++)for(let x=0;x<8;x++){
    const p=board[y][x];
    if(p&&p.color===color&&getCaptures(board,{x,y},p).length) return true;
  }
  return false;
}

function getQuietMoves(board,pos,piece){
  const res=[];
  if(piece.king){
    const dirs=[[1,1],[1,-1],[-1,1],[-1,-1]];
    for(const[dX,dY]of dirs){
      let x=pos.x+dX,y=pos.y+dY;
      while(x>=0&&x<8&&y>=0&&y<8){
        if(board[y][x]) break;
        res.push({from:pos,to:{x,y}});
        x+=dX;y+=dY;
      }
    }
  }else{
    const forward=piece.color==='white'?-1:1;
    for(const [dX,dY] of [[1,forward],[-1,forward]]){
      const tx=pos.x+dX,ty=pos.y+dY;
      if(tx>=0&&tx<8&&ty>=0&&ty<8&&!board[ty][tx]) res.push({from:pos,to:{x:tx,y:ty}});
    }
  }
  return res;
}

function computeLegalDestinations(board,playerColor,selectedPiece,roomState){
  if(!roomState||!selectedPiece) return [];
  if(roomState.turn!==playerColor) return [];

  const piece=board?.[selectedPiece.y]?.[selectedPiece.x];
  if(!piece||piece.color!==playerColor) return [];

  if(roomState.mustContinue!=null){
    if(roomState.mustContinue.player!==playerColor) return [];
    if(selectedPiece.x!==roomState.mustContinue.x||selectedPiece.y!==roomState.mustContinue.y) return [];
    return getCaptures(board,selectedPiece,piece).map(c=>c.to);
  }

  const mustCapture=playerMustCapture(board,playerColor);
  if(mustCapture) return getCaptures(board,selectedPiece,piece).map(c=>c.to);
  return getQuietMoves(board,selectedPiece,piece).map(m=>m.to);
}

function createBoardUI(){
  boardEl.innerHTML='';
  for(let y=0;y<8;y++){
    for(let x=0;x<8;x++){
      const c=document.createElement('div');
      c.className='cell '+((x+y)%2===0?'white':'black');
      c.dataset.x=x; c.dataset.y=y;
      boardEl.appendChild(c);
    }
  }
}

function renderBoard(board){
  createBoardUI();
  for(let y=0;y<8;y++){
    for(let x=0;x<8;x++){
      const p=board[y][x];
      if(p){
        const cell=boardEl.querySelector(`.cell[data-x='${x}'][data-y='${y}']`);
        const el=document.createElement('div');
        el.className='piece '+p.color;
        if(p.king) el.classList.add('king');
        if(selectedPiece && selectedPiece.x===x && selectedPiece.y===y) el.classList.add('selected');
        cell.appendChild(el);
      }
    }
  }

  // –º–∞—Ä–∫–µ—Ä—ã —Ö–æ–¥–æ–≤ —Ä–∏—Å—É–µ–º –ø–æ–≤–µ—Ä—Ö –∫–ª–µ—Ç–æ–∫
  renderMoveDots(legalMoves);
}

function startPolling(){
  setInterval(async ()=>{
    if(!roomId) return;
    const r=await fetch(`/room/${roomId}/state`);
    const d=await r.json();

    // –ï—Å–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ –±—ã–ª rematch (gameId –ø–æ–º–µ–Ω—è–ª—Å—è),
    // –Ω–∞–¥–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å–≤–æ–π color (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ü–≤–µ—Ç–∞ –º–µ–Ω—è—é—Ç—Å—è –º–µ—Å—Ç–∞–º–∏).
    if(typeof d.gameId === 'number' && lastGameId!=null && d.gameId!==lastGameId){
      await joinRoomById(roomId,{showModal:false, keepProfileConfirmed:true});
      // reset local UX selection
      selectedPiece=null;
      legalMoves=[];
      clearMoveDots();
      document.querySelectorAll('.piece.selected').forEach(p=>p.classList.remove('selected'));
      setWinnerBanner(null);
    }
    if(typeof d.gameId === 'number') lastGameId=d.gameId;

    roomState=d;

    const colorBox=document.getElementById('turnColorBox');
    if(colorBox){
      if(roomState.turn==='white'){
        colorBox.style.backgroundColor='#ffffff';
        colorBox.style.border='1px solid #000000';
      }else{
        colorBox.style.backgroundColor='#000000';
        colorBox.style.border='1px solid #ffffff';
      }
    }

    // –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–æ—Ç, –∫—Ç–æ —Ö–æ–¥–∏—Ç
    if(!playerColor || roomState.turn!==playerColor){
      selectedPiece=null;
      legalMoves=[];
    }

    // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å–µ—Ä–∏—é –≤–∑—è—Ç–∏–π ‚Äî –∞–≤—Ç–æ—Å–µ–ª–µ–∫—Ç–∏–º –Ω—É–∂–Ω—É—é —à–∞—à–∫—É
    if(playerColor && roomState.mustContinue && roomState.mustContinue.player===playerColor){
      selectedPiece={x:roomState.mustContinue.x,y:roomState.mustContinue.y};
    }

    legalMoves = (playerColor && selectedPiece)
      ? computeLegalDestinations(roomState.board, playerColor, selectedPiece, roomState)
      : [];

    // –ü–æ–±–µ–¥–∞: –µ—Å–ª–∏ —É –∫–æ–≥–æ-—Ç–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–∏ –æ–¥–Ω–æ–π —à–∞—à–∫–∏
    const counts=countPieces(d.board);
    if(counts.white===0 || counts.black===0){
      const winnerColor = counts.white===0 ? 'black' : 'white';
      const winnerSeatKey = seatKeyForColor(d,winnerColor); // 'p1' | 'p2'
      const winnerSeatNum = seatNumberFromKey(winnerSeatKey);
      const winnerProfile = winnerSeatKey ? (d.profiles?.[winnerSeatKey] || {name:''}) : {name:''};

      // –í –∑–∞–≥–æ–ª–æ–≤–∫–µ —É –Ω–∞—Å –≤—Å–µ–≥–¥–∞ "–ò–≥—Ä–æ–∫ 1/2", –∞ –∏–º—è ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ.
      const displayName = (winnerProfile?.name && winnerProfile.name.trim())
        ? winnerProfile.name.trim()
        : (winnerSeatNum ? `–ò–≥—Ä–æ–∫ ${winnerSeatNum}` : '–ò–≥—Ä–æ–∫');

      setWinnerBanner(`–ü–æ–±–µ–¥–∏–ª "${displayName}"`);
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏—è –≤ UI, –Ω–æ –¥–æ—Å–∫—É –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
      legalMoves=[];
      selectedPiece=null;
    }else{
      setWinnerBanner(null);
    }

    renderPlayerCards(d);

    // enable/disable –∫–Ω–æ–ø–∫–∏
    document.getElementById('invite').disabled = !roomId;
    document.getElementById('rematch').disabled = !roomId;

    renderBoard(d.board);
  },1000);
}

function applyBubblyButtonAnimations(){
  const animateButton = function(e){
    e.preventDefault();
    e.target.classList.remove('animate');
    e.target.classList.add('animate');
    setTimeout(()=>e.target.classList.remove('animate'),700);
  };
  const bubblyButtons=document.getElementsByClassName('bubbly-button');
  for(let i=0;i<bubblyButtons.length;i++){
    bubblyButtons[i].addEventListener('click', animateButton, false);
  }
}

function showProfileModal(defaultName){
  const backdrop=document.getElementById('profileModalBackdrop');
  const nameInput=document.getElementById('profileName');
  const grid=document.getElementById('avatarGrid');
  if(!backdrop||!nameInput||!grid) return;

  // —É—Ç–æ—á–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª–∫–∏
  const titleEl=document.getElementById('profileTitle');
  if(titleEl) titleEl.textContent = `–ò–º—è –∏–≥—Ä–æ–∫–∞ –∏ –∞–≤–∞—Ç–∞—Ä (${defaultName})`;

  // –∏–º—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage, –µ—Å–ª–∏ –µ—Å—Ç—å
  let savedName = '';
  if(seat){
    savedName = localStorage.getItem(PROFILE_NAME_KEY(seat)) || '';
  }
  nameInput.value = savedName;

  // –∞–≤–∞—Ç–∞—Ä - –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –∏–ª–∏ —Å–ª—É—á–∞–π–Ω—ã–π
  let savedAvatar = '';
  if(seat){
    savedAvatar = localStorage.getItem(PROFILE_AVATAR_KEY(seat)) || '';
  }
  chosenAvatar = savedAvatar && AVATARS.includes(savedAvatar) ? savedAvatar : AVATARS[Math.floor(Math.random()*AVATARS.length)];

  grid.innerHTML='';
  for(const a of AVATARS){
    const el=document.createElement('div');
    el.className='avatar-choice'+(a===chosenAvatar?' selected':'');
    el.textContent=a;
    el.onclick=()=>{
      chosenAvatar=a;
      grid.querySelectorAll('.avatar-choice').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
    };
    grid.appendChild(el);
  }

  backdrop.classList.add('show');
  setTimeout(()=>nameInput.focus(),0);
}

async function submitProfile(){
  if(!roomId || !playerColor) return;
  const name=(document.getElementById('profileName')?.value||'').trim();
  const avatar=(chosenAvatar||'').trim();

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è seat
  if(seat){
    localStorage.setItem(PROFILE_NAME_KEY(seat), name);
    localStorage.setItem(PROFILE_AVATAR_KEY(seat), avatar);
  }

  const r=await fetch(`/room/${roomId}/profile`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({clientId,name,avatar})
  });
  const d=await r.json();
  if(d?.error){
    alert(d.error);
    return;
  }
  profileConfirmed=true;
  document.getElementById('profileModalBackdrop')?.classList.remove('show');

  // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å polling
  const sk=seatKeyFromSeat(seat);
  if(sk && roomState){
    // –û–±–Ω–æ–≤–ª—è–µ–º roomState.profiles
    if(!roomState.profiles) roomState.profiles = {};
    roomState.profiles[sk] = d.profile;
    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º connected, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if(!roomState.connected) roomState.connected = {};
    if(sk === 'p1') roomState.connected.p1 = true;
    if(sk === 'p2') roomState.connected.p2 = true;
    renderPlayerCards(roomState);
  }
}

function getRoomIdFromUrl(){
  const u=new URL(location.href);
  const q=u.searchParams.get('room');
  return (q||'').trim() || null;
}

async function joinRoomById(id, opts={}){
  const {showModal=true, keepProfileConfirmed=false} = opts;
  const r=await fetch(`/room/${id}/join?clientId=${encodeURIComponent(clientId)}`);
  const d=await r.json();
  if(d.error) return {error:d.error};
  roomId=id;
  playerColor=d.color;
  seat=d.seat;
  profileConfirmed = keepProfileConfirmed ? profileConfirmed : false;
  document.getElementById('roomIdInput').value=roomId;
  if(playerColor==='black') boardEl.classList.add('flipped');
  else boardEl.classList.remove('flipped');
  document.getElementById('invite').disabled=false;
  document.getElementById('rematch').disabled=false;
  if(showModal) showProfileModal(seat===1?'–ò–≥—Ä–æ–∫ 1':'–ò–≥—Ä–æ–∫ 2');
  return {ok:true};
}

document.getElementById('createRoom').onclick=async()=>{
  const r=await fetch('/room/create');
  const d=await r.json();
  roomId=d.roomId;
  document.getElementById('roomIdInput').value=roomId;

  // —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
  const j=await joinRoomById(roomId,{showModal:true});
  if(j.error) return;
};

document.getElementById('joinRoom').onclick=async()=>{
  const id=document.getElementById('roomIdInput').value.trim();
  if(!id) return;
  const j=await joinRoomById(id,{showModal:true});
  if(j.error) return alert(j.error);
};

document.getElementById('invite').onclick=async()=>{
  if(!roomId) return;
  const url=`${location.origin}${location.pathname}?room=${encodeURIComponent(roomId)}`;
  try{
    await navigator.clipboard.writeText(url);
    showToast('—Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
  }catch{
    // fallback
    const tmp=document.createElement('textarea');
    tmp.value=url;
    document.body.appendChild(tmp);
    tmp.select();
    document.execCommand('copy');
    tmp.remove();
    showToast('—Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
  }
};

document.getElementById('rematch').onclick=async()=>{
  if(!roomId) return;
  await fetch(`/room/${roomId}/rematch`,{method:'POST'});
  // –ø–æ—Å–ª–µ —Ä–µ–º–∞—Ç—á–∞ –∑–∞–Ω–æ–≤–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Ü–≤–µ—Ç (–æ–Ω –ø–æ–º–µ–Ω—è–ª—Å—è),
  // –Ω–æ –ø—Ä–æ—Ñ–∏–ª—å –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–∫–Ω–∞.
  await joinRoomById(roomId,{showModal:false, keepProfileConfirmed:true});
  setWinnerBanner(null);

  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π UX-—Å–µ–ª–µ–∫—Ç/–ø–æ–¥—Å–≤–µ—Ç–∫–∏
  selectedPiece=null;
  legalMoves=[];
  clearMoveDots();
  document.querySelectorAll('.piece.selected').forEach(p=>p.classList.remove('selected'));
};

document.getElementById('profileOk').onclick=submitProfile;

// Enter –≤ –ø–æ–ª–µ –∏–º–µ–Ω–∏ = OK
document.getElementById('profileName')?.addEventListener('keydown',(e)=>{
  if(e.key==='Enter') submitProfile();
});

boardEl.addEventListener('click',async e=>{
  const cell=e.target.closest('.cell');
  if(!cell||!playerColor) return;
  if(!profileConfirmed) return; // –ø–æ–∫–∞ –Ω–µ –Ω–∞–∂–∞–ª –û–ö –≤ –º–æ–¥–∞–ª–∫–µ
  // –µ—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º –∫–ª–∏–∫–∏
  if(winnerBannerEl.style.display!=='none') return;
  const x=+cell.dataset.x, y=+cell.dataset.y;
  const piece=cell.querySelector('.piece');

  if(piece && piece.classList.contains(playerColor)){
    // –Ω–µ–ª—å–∑—è –≤—ã–±–∏—Ä–∞—Ç—å —à–∞—à–∫–∏, –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥
    if(!roomState || roomState.turn!==playerColor) return;
    // –µ—Å–ª–∏ –Ω–∞–¥–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≤–∑—è—Ç–∏–µ ‚Äî –≤—ã–±—Ä–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—É—é —à–∞—à–∫—É
    if(roomState.mustContinue && (x!==roomState.mustContinue.x || y!==roomState.mustContinue.y)) return;

    document.querySelectorAll('.piece.selected').forEach(p=>p.classList.remove('selected'));
    piece.classList.add('selected');
    selectedPiece={x,y};

    legalMoves=computeLegalDestinations(roomState.board,playerColor,selectedPiece,roomState);
    renderMoveDots(legalMoves);
    return;
  }

  if(selectedPiece){
    // —Ç–∏—Ö–∏–π UX: –µ—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    const isLegal=legalMoves.some(m=>m.x===x&&m.y===y);
    if(!isLegal) return;

    const r=await fetch(`/room/${roomId}/move`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({from:selectedPiece,to:{x,y},player:playerColor})
    });
    const d=await r.json();

    // –±–µ–∑ alert: –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º
    if(d.error) return;
         if(d.error) return;

    // === –ó–í–£–ö–ò ‚Äî 100% –¢–û–ß–ù–´–ô –í–ê–†–ò–ê–ù–¢ ===
    const fromX = selectedPiece.x;
    const fromY = selectedPiece.y;
    const toX = x;
    const toY = y;

    const oldPiece = roomState?.board?.[fromY]?.[fromX];  // —à–∞—à–∫–∞ –î–û —Ö–æ–¥–∞
    const newPiece = d.board?.[toY]?.[toX];               // —à–∞—à–∫–∞ –ü–û–°–õ–ï —Ö–æ–¥–∞ (–Ω–∞ –Ω–æ–≤–æ–π –∫–ª–µ—Ç–∫–µ)

    let hadCapture = false;

    // –ë—ã–ª–æ –≤–∑—è—Ç–∏–µ? –ò—Å—á–µ–∑–ª–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —à–∞—à–∫–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
    if (roomState?.board && d.board) {
      for (let y = 0; y < 8; y++) {
        for (let x = 0; x < 8; x++) {
          const oldP = roomState.board[y][x];
          const newP = d.board[y][x];
          if (oldP && !newP && oldP.color !== playerColor) {
            hadCapture = true;
          }
        }
      }
    }

    // –°—Ç–∞–ª–∞ –ª–∏ –ù–ê–®–ê —à–∞—à–∫–∞ –¥–∞–º–∫–æ–π –∏–º–µ–Ω–Ω–æ –Ω–∞ —ç—Ç–æ–º —Ö–æ–¥—É?
    const becameKing = newPiece &&
                       newPiece.color === playerColor &&
                       newPiece.king &&
                       oldPiece &&
                       !oldPiece.king;

    if (becameKing) {
      playSound('king');
    } else if (hadCapture) {
      playSound('capture');
    } else {
      playSound('move');
    }
    // =========================================
    // —É—Å–ø–µ—Ö
    if(d.board) roomState = {...(roomState||{}), board:d.board};
    if(typeof d.turn === 'string') roomState.turn = d.turn;
    if('mustContinue' in d) roomState.mustContinue = d.mustContinue;

    if(d.mustContinue){
      // —Å–µ—Ä–∏—è –≤–∑—è—Ç–∏–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
      if(roomState) roomState.mustContinue=d.mustContinue;
      selectedPiece={x:d.mustContinue.x,y:d.mustContinue.y};
      legalMoves=computeLegalDestinations(d.board,playerColor,selectedPiece,roomState);
      renderBoard(d.board);
      return;
    }

    // —Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω
    selectedPiece=null;
    legalMoves=[];
    clearMoveDots();
    document.querySelectorAll('.piece.selected').forEach(p=>p.classList.remove('selected'));
    if(d.board) renderBoard(d.board);
  }
});

createBoardUI();
startPolling();

applyBubblyButtonAnimations();

// –ê–≤—Ç–æ-join –ø–æ —Å—Å—ã–ª–∫–µ ?room=XXXX
(async()=>{
  const fromUrl=getRoomIdFromUrl();
  if(fromUrl){
    document.getElementById('roomIdInput').value=fromUrl;
    const j=await joinRoomById(fromUrl);
    if(j.error) alert(j.error);
  }
})();
</script>
	<script>
// === –ó–í–£–ö–ò –° –ù–ê–°–¢–†–û–ô–ö–û–ô –ì–†–û–ú–ö–û–°–¢–ò ===
const sounds = {
  move: new Audio('sounds/move.wav'),
  capture: new Audio('sounds/capture.mp3'),
  king: new Audio('sounds/king.mp3')
};

let volume = 0.6; // –Ω–∞—á–∞–ª—å–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å (60%)

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤—Å–µ–º –∑–≤—É–∫–∞–º
function setVolume(val) {
  volume = val;
  Object.values(sounds).forEach(s => s.volume = val);
  document.getElementById('volumeValue').textContent = Math.round(val * 100) + '%';
}

// –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–≤—É–∫–∞
let soundReady = false;
document.addEventListener('click', () => {
  if (soundReady) return;
  sounds.move.play().catch(() => {});
  soundReady = true;
}, {once: true});

// –ü–æ–ª–∑—É–Ω–æ–∫
document.getElementById('volumeSlider').addEventListener('input', (e) => {
  setVolume(e.target.value / 100);
});

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
setVolume(0.6); // 60% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

function playSound(type) {
  if (!soundReady || !sounds[type]) return;
  const s = sounds[type];
  s.currentTime = 0;
  s.volume = volume;
  s.play().catch(() => {});
}
</script>
</body>
</html>
